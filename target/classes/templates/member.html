<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Member Dashboard</title>
    <script>
        function togglePlanFields() {
            const packageSelect = document.getElementById("packageSelect");
            const packagePlanRadio = document.getElementById("packagePlan");

            if (packagePlanRadio.checked) {
                packageSelect.disabled = false;
            } else {
                packageSelect.disabled = true;
            }
        }

        window.unload = togglePlanFields;
    </script>
</head>
<body>
<h1>Welcome, <span th:text="${member.name}"></span>!</h1>

<!-- Display current trainer -->
<div>
    <h2>Your Trainer</h2>
    <div th:if="${member.trainer != null}">
        <p>Current Trainer: <span th:text="${member.trainer.name}"></span></p>
        <form th:action="@{/member/change-trainer}" method="post">
            <label>Select New Trainer:</label>
            <select name="trainerId" required>
                <option th:each="trainer : ${trainers}"
                        th:value="${trainer.trainerId}"
                        th:text="${trainer.name}">
                </option>
            </select>
            <button type="submit">Change Trainer</button>
        </form>
    </div>
    <div th:if="${member.trainer == null}">
        <p>You have not selected a trainer yet.</p>
        <form th:action="@{/member/choose-trainer}" method="post">
            <label>Select Trainer:</label>
            <select name="trainerId" required>
                <option th:each="trainer : ${trainers}"
                        th:value="${trainer.trainerId}"
                        th:text="${trainer.name}">
                </option>
            </select>
            <button type="submit">Choose Trainer</button>
        </form>
    </div>
</div>

<!-- Plan selection and update -->
<div>
    <h2 th:text="${member.paymentPlanType == null ? 'Choose Your Plan' : 'Update Your Plan'}"></h2>

    <form th:action="@{/member/update-plan}" method="post">
        <div class="form-group">
            <label>Choose Plan:</label>
            <div class="radio-group">
                <input type="radio" name="paymentPlanType" value="SessionPerWeek" id="sessionPerWeek"
                       th:checked="${member.paymentPlanType == 'SessionPerWeek'}" required/>
                <label for="sessionPerWeek">Session Per Week Plan</label>
            </div>
            <div class="radio-group">
                <input type="radio" name="paymentPlanType" value="Package" id="packagePlan"
                       th:checked="${member.paymentPlanType == 'Package'}" required/>
                <label for="packagePlan">Package Plan</label>
            </div>
        </div>

        <div class="form-group" th:if="${packages.size() > 0}">
            <label>Select Package:</label>
            <select name="packageId" th:disabled="${member.paymentPlanType != 'Package'}">
                <option th:each="package : ${packages}"
                        th:value="${package.packageId}"
                        th:text="${package.name}"
                        th:selected="${member.gymPackage != null and member.gymPackage.packageId == package.packageId}">
                </option>
            </select>
        </div>

<!--        <div th:if="${member.paymentPlanType == 'SessionPerWeek'}">-->
<!--            <h3>Select Preferred Day and Time Slots</h3>-->
<!--            <div th:each="slot : ${availableSlots}">-->
<!--                <label>-->
<!--                    <input type="checkbox" name="preferredSlotIds"-->
<!--                           th:value="${slot.id}"-->
<!--                           th:checked="${member.preferredSlots != null and member.preferredSlots.contains(slot)}" />-->
<!--                    <span th:text="${slot.dayOfWeek + ' - ' + slot.time}"></span>-->
<!--                </label><br/>-->
<!--            </div>-->
<!--        </div>-->

        <button type="submit" th:text="${member.paymentPlanType == null ? 'Save Plan' : 'Update Plan'}"></button>
    </form>
</div>

<h3>Find Available Trainers for Multiple Days</h3>

<form id="availabilityForm" onsubmit="handleTrainerCheck(event)">
    <table>
        <tr>
            <th>Select</th>
            <th>Day</th>
            <th>Time</th>
        </tr>
        <tr th:each="day : ${T(java.time.DayOfWeek).values()}">
            <td>
                <input type="checkbox" name="selectedDays" th:value="${day}" onchange="toggleTimeInput(this)">
            </td>
            <td th:text="${day}"></td>
            <td>
                <input type="time" th:name="'timeMap[' + ${day} + ']'" disabled>
            </td>
        </tr>
    </table>
    <br>
    <button type="submit">Check Trainers</button>
</form>

<div id="multiTrainerResults"></div>
<hr>
<h3>Booking Summary</h3>
<div id="bookingSummary"></div>


<script>
    function toggleTimeInput(checkbox) {
        const row = checkbox.closest("tr");
        const timeInput = row.querySelector("input[type='time']");
        timeInput.disabled = !checkbox.checked;
    }

    function handleTrainerCheck(event) {
        event.preventDefault();

        const form = document.getElementById("availabilityForm");
        const selected = Array.from(form.querySelectorAll("input[name='selectedDays']:checked"));

        const resultDiv = document.getElementById("multiTrainerResults");
        resultDiv.innerHTML = "";

        if (selected.length === 0) {
            resultDiv.innerHTML = "<p>Please select at least one day.</p>";
            return;
        }

        selected.forEach(dayCheckbox => {
            const day = dayCheckbox.value;
            const timeInput = dayCheckbox.closest("tr").querySelector("input[type='time']");
            const time = timeInput.value;

            if (!time) {
                resultDiv.innerHTML += `<p>Please enter time for ${day}.</p>`;
                return;
            }

            fetch(`/member/available-trainers?day=${day}&time=${time}`)
                .then(response => response.json())
                .then(data => {
                    const section = document.createElement("div");
                    section.innerHTML = `<h4>Available Trainers on ${day} at ${time}</h4>`;

                    if (data.length === 0) {
                        section.innerHTML += "<p>No trainers available.</p>";
                    } else {
                        const form = document.createElement("form");

                        const select = document.createElement("select");
                        select.name = "trainerId";

                        data.forEach(trainer => {
                            const option = document.createElement("option");
                            option.value = trainer.id;
                            option.textContent = trainer.name;
                            select.appendChild(option);
                        });

                        const hiddenDay = document.createElement("input");
                        hiddenDay.type = "hidden";
                        hiddenDay.name = "day";
                        hiddenDay.value = day;

                        const hiddenTime = document.createElement("input");
                        hiddenTime.type = "hidden";
                        hiddenTime.name = "time";
                        hiddenTime.value = time;

                        const submit = document.createElement("button");
                        submit.type = "submit";
                        submit.textContent = "Book Session";

                        form.onsubmit = function (e) {
                            e.preventDefault();
                            const trainerId = select.value;
                            const trainerName = select.options[select.selectedIndex].text;

                            fetch("/member/book-session", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/x-www-form-urlencoded"
                                },
                                body: new URLSearchParams({
                                    trainerId: trainerId,
                                    day: day,
                                    time: time
                                })
                            })
                            .then(response => response.text())
                            .then(result => {
                                let summary = document.getElementById("bookingSummary");
                                if (!summary) {
                                    summary = document.createElement("div");
                                    summary.id = "bookingSummary";
                                    summary.innerHTML = "<h3>Booking Summary</h3>";
                                    document.body.appendChild(summary);
                                }

                                // Convert DayOfWeek to upcoming date
                                const today = new Date();
                                const dayIndex = ["SUNDAY", "MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY"].indexOf(day.toUpperCase());
                                let targetDate = new Date();
                                targetDate.setDate(today.getDate() + ((7 + dayIndex - today.getDay()) % 7));
                                const formattedDate = targetDate.toISOString().split('T')[0];

                                const entry = document.createElement("div");
                                entry.innerHTML = `
                                    <p><strong>${day} (${formattedDate}) at ${time}</strong> - Trainer: ${trainerName} <br>Result: ${result}</p>
                                    <button type="button" onclick="this.parentElement.remove()">Cancel</button>
                                `;
                                summary.appendChild(entry);
                            });
                        };

                        form.appendChild(select);
                        form.appendChild(hiddenDay);
                        form.appendChild(hiddenTime);
                        form.appendChild(submit);
                        section.appendChild(form);
                    }

                    resultDiv.appendChild(section);
                });
        });
    }
</script>


<!-- Logout -->
<div>
    <br />
    <a th:href="@{/logout}">Logout</a>
</div>
</body>
</html>
